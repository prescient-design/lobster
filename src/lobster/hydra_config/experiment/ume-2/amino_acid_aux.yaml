# @package _global_

defaults:
  - override /data: null
  - override /callbacks: [base]
  - override /model: null
  - override /lr_scheduler: null

compile: false

biopython_features: [
    "sequence_length",
    "molecular_weight",
    "aromaticity_index",
    "instability_index",
    "isoelectric_point",
    "alpha_helix_fraction",
    "turn_structure_fraction",
    "beta_sheet_fraction",
    "molar_extinction_coefficient_reduced_cysteines",
    "molar_extinction_coefficient_oxidized_cysteines",
    "grand_average_hydropathy_index",
    "net_charge_at_ph_6",
    "net_charge_at_ph_7"
  ]

data:
  _target_: lobster.data.UMELightningDataModule
  datasets:
    - AMPLIFY
    - PeptideAtlas
  root: ${oc.env:LOBSTER_DATA_DIR}
  max_length: 1024
  seed: 0
  batch_size: 64
  pin_memory: true
  num_workers: 8
  use_shared_tokenizer: false
  dataset_kwargs:
    AMPLIFY:
      extra_transform_fns:
        biopython:
          _target_: lobster.transforms.ProteinToBioPythonFeaturesTransform
          feature_list: ${biopython_features}
          standardize: true
    PeptideAtlas:
      extra_transform_fns:
        biopython:
          _target_: lobster.transforms.ProteinToBioPythonFeaturesTransform
          feature_list: ${biopython_features}
          standardize: true

model:
  _target_: lobster.model.ume2.UMESequenceEncoderLightningModule 
  auxiliary_tasks:
    - _target_: lobster.model.ume2.AuxiliaryTask
      name: biopython
      task_type: regression
      output_dim: 13
      hidden_size: null
      loss_weight: 0.00
      pooling: cls
      num_layers: 2
      dropout: 0.1
  lr: 1e-5
  scheduler: constant_with_warmup
  scheduler_kwargs:
    num_warmup_steps: 0
  weight_decay: 0.01
  mask_token_id: 32
  pad_token_id: 1
  special_token_ids: [0, 1, 2, 3, 32]
  mask_probability: 0.15
  ckpt_path: s3://prescient-lobster/ume/runs/2025-09-15T18-16-43/epoch=0-step=2000-val_loss=0.8006.ckpt
  encoder_kwargs:
    max_length: ${data.max_length}
    # model_ckpt: s3://prescient-lobster/ume/runs/2025-09-03T15-31-34/epoch=2-step=89000-val_loss=0.8960.ckpt
    cache_dir: /data2/ume/checkpoints
    model_size: small
    vocab_size: 33

logger:
  name: UME-2-protein-cls-${model.encoder_kwargs.model_size}_${data.datasets}_${paths.timestamp}
  project: lobster
  entity: ${oc.env:LOBSTER_USER}
  save_dir: ${oc.env:LOBSTER_RUNS_DIR}
  tags:
    - debug
    - protein
    - with-auxiliary-tasks
    - aa-tokenizer
    - zero-weight-on-auxiliary-tasks

paths:
  timestamp: ${now:%Y-%m-%d}T${now:%H-%M-%S} 
  output_dir: ${paths.root_dir}/${paths.timestamp}
  root_dir: ${oc.env:LOBSTER_RUNS_DIR}

trainer:
  num_nodes: 1
  max_epochs: -1
  gradient_clip_val: 0.5
  max_time: null
  max_steps: -1
  val_check_interval: 500
  limit_val_batches: 50_000
  precision: 16-mixed
  accumulate_grad_batches: 4
  devices: auto
  strategy: ddp_find_unused_parameters_true

callbacks:
  model_checkpoint:
    save_top_k: -1
    every_n_train_steps: 500
  auxiliary_task_weight_scheduler:
    _target_: lobster.callbacks.AuxiliaryTaskWeightScheduler
    schedule_type: linear
    start_step: 3000
    ramp_steps: 10000
    max_weight: 0.05
    task_name: biopython
  # batch_size_finder:
  #   _target_: lightning.pytorch.callbacks.BatchSizeFinder
  #   mode: power
  #   steps_per_trial: 3
  #   init_val: 64
  #   max_trials: 25
  #   batch_arg_name: batch_size
